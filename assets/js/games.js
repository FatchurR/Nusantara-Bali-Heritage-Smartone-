(()=>{const $=(q,el=document)=>el.querySelector(q);const $$=(q,el=document)=>Array.from(el.querySelectorAll(q));const yearEl=$("#year");const highScoreEl=$("#highScore");const hudRegionEl=$("#hudRegion");const hudScoreEl=$("#hudScore");const hudLivesEl=$("#hudLives");const qIndexEl=$("#qIndex");const qTotalEl=$("#qTotal");const qTitleEl=$("#questionTitle");const optionsEl=$("#options");const btnStart=$("#btnStart");const btnNext=$("#btnNext");const btnReplay=$("#btnReplay");const explainWrap=$("#explainWrap");const explainText=$("#explainText");const learnLink=$("#learnLink");const endWrap=$("#endWrap");const endTitle=$("#endTitle");const endText=$("#endText");const resetAllBtn=$("#resetAll");const toggleSfxBtn=$("#toggleSfx");const sfxLabel=$("#sfxLabel");const sfxClick=$("#sfxClick");let sfxOn=!0;if(yearEl)yearEl.textContent=new Date().getFullYear();const BANK={west:{name:"West Bali",learnDefault:"rituals.html",questions:[{q:"Dalam konteks budaya Bali, apa tujuan utama ritual pembersihan simbolik (mis. Melasti)?",a:["Memperkuat keterikatan sosial dan menata batin melalui simbol penyucian","Sekadar hiburan publik","Menentukan pemenang kompetisi adat","Mengubah simbol sakral untuk estetika"],correct:0,explain:"Ritual pembersihan simbolik dipahami sebagai cara menata kembali relasi manusia–alam–spiritual. Visualnya penting, tetapi maknanya lebih penting.",learn:"rituals.html"},{q:"Apa sikap yang paling tepat saat menyaksikan tradisi/ritual budaya di Bali?",a:["Mengambil bagian tanpa izin agar terasa 'authentic'","Mengutamakan hormat: jaga jarak, ikuti aturan lokal, dan minta izin","Mengganggu alur ritual demi konten","Membuat candaan tentang hal sakral"],correct:1,explain:"Prinsip dasarnya: hormat dan taat etika setempat. Jika ragu, bertanya dengan sopan kepada panitia/pendamping lokal adalah pilihan terbaik.",learn:"rituals.html"},{q:"Kenapa banyak tradisi Bali terasa ‘sinema’ meski tanpa panggung modern?",a:["Karena selalu dibuat untuk turis","Karena ruang, simbol, dan ritme kolektif membentuk pengalaman yang imersif","Karena semua ritual wajib direkam","Karena tidak ada aturan adat"],correct:1,explain:"Pengalaman budaya lahir dari kombinasi ruang, simbol, musik/ritme, dan partisipasi komunal—bukan semata dekorasi.",learn:"temples.html"},{q:"Apa yang membuat sebuah pertunjukan budaya tetap ‘edukatif’, bukan sekadar sensasi?",a:["Memotong konteks agar cepat viral","Memberi konteks: makna, etika, dan batas yang dihormati","Menambah unsur horor berlebihan","Menyebut semua hal ‘mistis’ tanpa penjelasan"],correct:1,explain:"Edukasi lahir dari konteks: apa maknanya, kapan dilakukan, oleh siapa, dan batas etika yang dijaga.",learn:"index.html"}]},central:{name:"Central Bali",learnDefault:"temples.html",questions:[{q:"Dalam arsitektur Bali, ‘ruang’ sering dipahami sebagai…",a:["Sekadar tempat kosong untuk lalu lintas","Bahasa simbolik: mengarahkan sikap, gerak, dan kesadaran","Dekorasi semata","Aturan yang bisa diabaikan"],correct:1,explain:"Ruang adalah etika: gerbang, halaman, dan zona mengatur transisi batin—bagaimana seseorang hadir dan bersikap.",learn:"temples.html"},{q:"Apa gagasan besar yang sering dipakai untuk memahami keseimbangan hidup di Bali?",a:["Tri Hita Karana (harmoni manusia–alam–spiritual)","Satu pihak harus selalu menang","Semua tradisi harus diseragamkan","Menghapus perbedaan budaya"],correct:0,explain:"Tri Hita Karana sering dipakai sebagai kunci pemahaman: menjaga harmoni dalam tiga relasi utama secara berkelanjutan.",learn:"index.html"},{q:"Mengapa ‘gerbang’ (threshold) dalam ruang tradisi penting secara simbolik?",a:["Hanya untuk foto","Menandai transisi: dari profan ke sakral, dari luar ke dalam","Untuk mempersempit jalur","Agar orang tersesat"],correct:1,explain:"Gerbang bukan sekadar pintu, tetapi simbol transisi sikap dan niat.",learn:"temples.html"},{q:"Saat membaca tradisi, apa yang sebaiknya didahulukan?",a:["Konteks & makna, baru visual","Visual saja, konteks tidak penting","Sensasi agar ramai","Mitos tanpa batas"],correct:0,explain:"Visual itu ‘pintu masuk’, tetapi makna & konteks membuat pengalaman jadi pemahaman.",learn:"rituals.html"}]},east:{name:"East Bali",learnDefault:"rituals.html",questions:[{q:"Galungan dan Kuningan sering dipahami sebagai penegasan…",a:["Kemenangan dharma atas adharma, dan pemeliharaan harmoni","Kompetisi antar desa","Larangan tradisi","Mengubah simbol sakral demi tren"],correct:0,explain:"Esensinya bukan ‘menang’ lalu selesai, tetapi merawat keteraturan dan harmoni yang diulang dalam siklus.",learn:"rituals.html"},{q:"Makna ‘keseimbangan’ dalam budaya Bali lebih dekat pada…",a:["Sekali berhasil lalu selesai","Proses perawatan yang terus diulang (practice)","Menghilangkan ritual","Mengutamakan sensasi"],correct:1,explain:"Banyak tradisi menekankan practice: keseimbangan dijaga lewat kebiasaan, etika, dan ritme komunal.",learn:"rituals.html"},{q:"Tarian Barong sering dibaca sebagai simbol…",a:["Konflik dan keseimbangan energi (bukan sekadar horor)","Sekadar kostum lucu","Ajang lomba kostum","Cerita modern tanpa konteks"],correct:0,explain:"Barong kerap dimaknai sebagai simbol proteksi dan keseimbangan. Pembacaannya harus tetap beretika dan tidak disensasikan.",learn:"dance-detail.html?dance=barong"},{q:"Mengapa penjelasan singkat setelah jawaban penting dalam game edukasi budaya?",a:["Agar kuis terasa lebih lama","Agar pemain mendapat konteks, bukan hanya benar/salah","Agar bisa menghakimi budaya","Agar bisa menyederhanakan berlebihan"],correct:1,explain:"Tujuannya: memperkaya konteks. Budaya tidak cocok dipadatkan jadi benar/salah tanpa penjelasan.",learn:"index.html"}]}};const MAX_LIVES=3;let regionKey=null;let lives=MAX_LIVES;let score=0;let i=0;let locked=!1;let deck=[];const HS_KEY="nbh_highscore_v1";function getHS(){try{return JSON.parse(localStorage.getItem(HS_KEY))||{global:0,west:0,central:0,east:0}}catch{return{global:0,west:0,central:0,east:0}}}
function setHS(obj){localStorage.setItem(HS_KEY,JSON.stringify(obj))}
function bestScoreFor(k){const hs=getHS();return Math.max(hs[k]||0,hs.global||0)}
function playSfx(){if(!sfxOn)return;if(sfxClick&&sfxClick.querySelector("source")?.getAttribute("src")){try{sfxClick.currentTime=0;sfxClick.volume=0.18;sfxClick.play().catch(()=>fallbackClick());return}catch{}}
fallbackClick()}
function fallbackClick(){try{const ctx=new(window.AudioContext||window.webkitAudioContext)();const o=ctx.createOscillator();const g=ctx.createGain();o.type="sine";o.frequency.value=740;g.gain.value=0.0001;o.connect(g);g.connect(ctx.destination);const now=ctx.currentTime;g.gain.setValueAtTime(0.0001,now);g.gain.exponentialRampToValueAtTime(0.05,now+0.01);g.gain.exponentialRampToValueAtTime(0.0001,now+0.10);o.start(now);o.stop(now+0.11)}catch{}}
function setHighScoreUI(){const hs=getHS();const byRegion=regionKey?(hs[regionKey]||0):0;const global=hs.global||0;highScoreEl.textContent=regionKey?`${byRegion} (Region) / ${global} (Global)`:`${global}`}
function renderLives(){hudLivesEl.innerHTML="";for(let n=0;n<MAX_LIVES;n++){const alive=n<lives;const span=document.createElement("span");span.className="inline-flex items-center justify-center w-6 h-6 rounded-full border border-gold/20 bg-obsidian/40";span.innerHTML=alive?`<span class="text-gold" aria-hidden="true">✦</span>`:`<span class="text-ash/30" aria-hidden="true">✦</span>`;hudLivesEl.appendChild(span)}}
function setHud(){hudRegionEl.textContent=regionKey?BANK[regionKey].name:"—";hudScoreEl.textContent=String(score);renderLives();setHighScoreUI()}
function shuffle(arr){const a=[...arr];for(let j=a.length-1;j>0;j--){const r=Math.floor(Math.random()*(j+1));[a[j],a[r]]=[a[r],a[j]]}
return a}
function resetRun(){lives=MAX_LIVES;score=0;i=0;locked=!1;deck=shuffle(BANK[regionKey].questions).map(q=>({...q,_packed:packOptions(q)}));endWrap.classList.add("hidden");explainWrap.classList.add("hidden");btnStart.textContent="Mulai";btnStart.disabled=!1;qTotalEl.textContent=String(deck.length);setHud();renderQuestion()}
function packOptions(q){const items=q.a.map((txt,idx)=>({txt,idx}));const shuffled=shuffle(items);const correctIndex=shuffled.findIndex(x=>x.idx===q.correct);return{opts:shuffled.map(x=>x.txt),correctIndex}}
function renderQuestion(){if(!regionKey){qTitleEl.textContent="Pilih wilayah di peta untuk memulai.";optionsEl.innerHTML="";qIndexEl.textContent="0";qTotalEl.textContent="0";return}
if(lives<=0){finish(!1);return}
if(i>=deck.length){finish(!0);return}
locked=!1;explainWrap.classList.add("hidden");endWrap.classList.add("hidden");const item=deck[i];qIndexEl.textContent=String(i+1);qTitleEl.textContent=item.q;optionsEl.innerHTML="";item._packed.opts.forEach((txt,idx)=>{const btn=document.createElement("button");btn.type="button";btn.className="btn-opt w-full text-left rounded-2xl border border-gold/15 bg-obsidian/40 px-4 py-3 text-sm text-ash/90 hover:border-gold/35 transition";btn.innerHTML=`<span class="text-gold/80 mr-2">${String.fromCharCode(65+idx)}.</span> ${txt}`;btn.addEventListener("click",()=>answer(idx));optionsEl.appendChild(btn)});learnLink.href=item.learn||BANK[regionKey].learnDefault||"index.html"}
function answer(chosenIdx){if(locked)return;locked=!0;playSfx();const item=deck[i];const correctIdx=item._packed.correctIndex;const optionButtons=$$("#options button");optionButtons.forEach((b,idx)=>{b.disabled=!0;if(idx===correctIdx){b.classList.add("border-gold/55");b.classList.add("shadow-[0_0_0_1px_rgba(200,169,81,.20),0_0_18px_rgba(200,169,81,.12)]")}
if(idx===chosenIdx&&chosenIdx!==correctIdx){b.classList.add("border-red-500/40");b.classList.add("shake")}});if(chosenIdx===correctIdx){score+=25;hudScoreEl.classList.add("pop");setTimeout(()=>hudScoreEl.classList.remove("pop"),180)}else{lives-=1;hudLivesEl.classList.add("shake");setTimeout(()=>hudLivesEl.classList.remove("shake"),280)}
explainText.textContent=item.explain||"—";explainWrap.classList.remove("hidden");setHud()}
function next(){if(lives<=0){finish(!1);return}
i+=1;renderQuestion()}
function finish(win){const hs=getHS();if(regionKey){hs[regionKey]=Math.max(hs[regionKey]||0,score)}
hs.global=Math.max(hs.global||0,score);setHS(hs);setHighScoreUI();optionsEl.innerHTML="";explainWrap.classList.add("hidden");endWrap.classList.remove("hidden");endTitle.textContent=win?"Level selesai":"Game over";endText.textContent=win?`Kamu menuntaskan level ${BANK[regionKey].name}. Score kamu: ${score}. Coba ulang untuk high score yang lebih tinggi.`:`Nyawa habis di level ${BANK[regionKey].name}. Score kamu: ${score}. Ulangi untuk memperbaiki ritme dan pemahaman.`}
function selectRegion(key){if(!BANK[key])return;regionKey=key;$$(".region").forEach(p=>p.classList.toggle("is-selected",p.dataset.region===key));$$(".lvlBtn").forEach(b=>b.classList.toggle("border-gold/45",b.dataset.region===key));setHud();resetRun()}
$$(".region").forEach(p=>p.addEventListener("click",()=>selectRegion(p.dataset.region)));$$(".lvlBtn").forEach(b=>b.addEventListener("click",()=>selectRegion(b.dataset.region)));if(btnStart)btnStart.addEventListener("click",()=>{if(!regionKey)return;playSfx();resetRun()});if(btnNext)btnNext.addEventListener("click",()=>{playSfx();next()});if(btnReplay)btnReplay.addEventListener("click",()=>{playSfx();resetRun()});if(toggleSfxBtn)toggleSfxBtn.addEventListener("click",()=>{sfxOn=!sfxOn;sfxLabel.textContent=sfxOn?"On":"Off";playSfx()});if(resetAllBtn)resetAllBtn.addEventListener("click",()=>{const ok=confirm("Reset semua high score? (Global + per wilayah)");if(!ok)return;localStorage.removeItem(HS_KEY);setHighScoreUI();playSfx()});setHud();renderQuestion();setHighScoreUI()})()